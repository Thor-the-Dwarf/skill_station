<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <title>Mini-Escape-Game</title>
    <link rel="stylesheet" href="Escape-Game.css">
</head>

<body>
<div class="page">
    <main class="panel">
        <header class="header">
            <div class="title-block">
                <h1>Mini-Escape-Room</h1>
                <p>Löse alle Aufgaben, bevor die Zeit ebgelaufen ist</p>
            </div>
            <div class="stats">
                <div class="stat-chip stat-chip--timer">
                    <span>Zeit</span>
                    <span id="stat-timer">03:00</span>
                </div>
                <div class="stat-chip">
                    <span>Rätsel gelöst</span>
                    <span id="stat-solved">0 / 3</span>
                </div>
            </div>
        </header>

        <div class="toolbar">
            <button class="btn-secondary btn" id="restart-btn" type="button">
                <span>↻</span> Neu starten
            </button>
        </div>

        <div class="door-wrapper">
            <!-- KEIN Text-Label mehr neben der Tür -->
            <div class="door-scene">
                <div class="door-sign door-sign--closed" id="door-sign">GESCHLOSSEN</div>
                <div class="door" id="door"></div>
                <div class="door-floor"></div>
                <div class="door-glow" id="door-glow"></div>
            </div>
        </div>

        <div class="layout-grid">
            <!-- Sortieraufgabe Haftung -->
            <section class="section-card" id="section-sort">
                <div class="section-header">
                    <div>
                        <div class="section-title">Rätsel 1: Haftung einsortieren</div>
                        <div class="section-sub">Ziehe die Haftungseigenschaften in die passende Kategorie.</div>
                    </div>
                    <div class="section-status" id="status-sort">offen</div>
                </div>
                <div class="section-body">
                    <div class="sort-pool" id="sort-pool"></div>
                    <div class="sort-board">
                        <div class="escape-dropzone" data-zone="person">
                            <div class="escape-dropzone-label">
                                Personengesellschaften<br>
                                <span style="font-size:10px;color:var(--muted);">(Einzelunternehmen, GbR, OHG, KG)</span>
                            </div>
                        </div>
                        <div class="escape-dropzone" data-zone="kapital">
                            <div class="escape-dropzone-label">
                                Kapitalgesellschaften<br>
                                <span style="font-size:10px;color:var(--muted);">(GmbH, UG)</span>
                            </div>
                        </div>
                        <div class="escape-dropzone" data-zone="beide">
                            <div class="escape-dropzone-label">Kann zu beiden passen</div>
                        </div>
                    </div>
                </div>
                <div class="section-footer">
                    <!-- KEIN Hint-Text -->
                    <button class="btn" id="check-sort-btn" type="button">
                        <span>✔</span> Rätsel prüfen
                    </button>
                </div>
            </section>

            <!-- Quiz -->
            <section class="section-card" id="section-quiz">
                <div class="section-header">
                    <div>
                        <div class="section-title">Rätsel 2: Kurz-Quiz Rechtsformen</div>
                        <div class="section-sub">Beantworte zwei Fragen – jede mit einer richtigen Antwort.</div>
                    </div>
                    <div class="section-status" id="status-quiz">offen</div>
                </div>
                <div class="section-body">
                    <div class="quiz-question" data-quiz-id="q1">
                        <div class="quiz-text">1. Welche Aussage zur GmbH stimmt?</div>
                        <ul class="quiz-options">
                            <li><label><input type="radio" name="q1" value="a"> Die Gesellschafter haften immer mit
                                ihrem gesamten Privatvermögen.</label></li>
                            <li><label><input type="radio" name="q1" value="b"> Es gibt kein gesetzliches
                                Mindestkapital.</label></li>
                            <li><label><input type="radio" name="q1" value="c"> Es ist ein Stammkapital von 25.000 €
                                vorgeschrieben.</label></li>
                        </ul>
                    </div>
                    <div class="quiz-question" data-quiz-id="q2">
                        <div class="quiz-text">2. Was ist typisch für eine GbR?</div>
                        <ul class="quiz-options">
                            <li><label><input type="radio" name="q2" value="a"> Es muss mindestens eine Million Euro
                                Kapital eingebracht werden.</label></li>
                            <li><label><input type="radio" name="q2" value="b"> Mindestens zwei Personen schließen
                                sich zusammen und haften persönlich.</label></li>
                            <li><label><input type="radio" name="q2" value="c"> Sie ist immer an der Börse
                                notiert.</label></li>
                        </ul>
                    </div>
                    <div class="quiz-feedback" id="quiz-feedback">Wähle je Frage eine Antwort.</div>
                </div>
                <div class="section-footer">
                    <!-- KEIN Hint-Text -->
                    <button class="btn" id="check-quiz-btn" type="button">
                        <span>✔</span> Quiz prüfen
                    </button>
                </div>
            </section>

            <!-- Mindestkapital -->
            <section class="section-card" id="section-capital">
                <div class="section-header">
                    <div>
                        <div class="section-title">Rätsel 3: Form → Mindestkapital</div>
                        <div class="section-sub">Ordne das typische Mindestkapital zu den Rechtsformen zu.</div>
                    </div>
                    <div class="section-status" id="status-capital">offen</div>
                </div>
                <div class="section-body">
                    <table class="capital-table">
                        <thead>
                        <tr>
                            <th>Rechtsform</th>
                            <th>Mindestkapital</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td>Einzelunternehmen</td>
                            <td>
                                <select data-form="Einzelunternehmen">
                                    <option value="">– bitte wählen –</option>
                                    <option value="kein">kein gesetzliches Mindestkapital</option>
                                    <option value="1euro">ab 1 € Stammkapital</option>
                                    <option value="25000">25.000 € Stammkapital</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>GbR</td>
                            <td>
                                <select data-form="GbR">
                                    <option value="">– bitte wählen –</option>
                                    <option value="kein">kein gesetzliches Mindestkapital</option>
                                    <option value="1euro">ab 1 € Stammkapital</option>
                                    <option value="25000">25.000 € Stammkapital</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>UG (haftungsbeschränkt)</td>
                            <td>
                                <select data-form="UG">
                                    <option value="">– bitte wählen –</option>
                                    <option value="kein">kein gesetzliches Mindestkapital</option>
                                    <option value="1euro">ab 1 € Stammkapital</option>
                                    <option value="25000">25.000 € Stammkapital</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>GmbH</td>
                            <td>
                                <select data-form="GmbH">
                                    <option value="">– bitte wählen –</option>
                                    <option value="kein">kein gesetzliches Mindestkapital</option>
                                    <option value="1euro">ab 1 € Stammkapital</option>
                                    <option value="25000">25.000 € Stammkapital</option>
                                </select>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <div class="section-footer">
                    <!-- KEIN Hint-Text -->
                    <button class="btn" id="check-capital-btn" type="button">
                        <span>✔</span> Zuordnung prüfen
                    </button>
                </div>
            </section>
        </div>
    </main>
</div>

<!-- ganz unten in deiner Datei: ERSETZE dein komplettes <script> durch dieses -->
<script type="module">
    const CONFIG_URL = 'Escape-Game-data2.json'; // Name deiner JSON-Datei

    // Timer
    const START_SECONDS = 180;
    let remainingSeconds = START_SECONDS;
    let timerId = null;
    let gameLocked = false;

    const statTimerEl = document.getElementById("stat-timer");
    const statSolvedEl = document.getElementById("stat-solved");
    const statStatusEl = document.getElementById("stat-status");

    const restartBtn = document.getElementById("restart-btn");

    const doorEl = document.getElementById("door");
    const doorSignEl = document.getElementById("door-sign");
    const doorGlowEl = document.getElementById("door-glow");

    const statusSortEl = document.getElementById("status-sort");
    const statusQuizEl = document.getElementById("status-quiz");
    const statusCapitalEl = document.getElementById("status-capital");

    const checkSortBtn = document.getElementById("check-sort-btn");
    const checkQuizBtn = document.getElementById("check-quiz-btn");
    const checkCapitalBtn = document.getElementById("check-capital-btn");

    // Sortieraufgabe – DOM
    const sortPoolEl = document.getElementById("sort-pool");
    const dropzones = document.querySelectorAll(".escape-dropzone");

    // Daten werden jetzt aus JSON geladen:
    let sortCardsData = [];
    let quizSolutions = {};
    let capitalSolutions = {};

    const capitalSelects = document.querySelectorAll(".capital-table select");

    const sectionSolved = {
        sort: false,
        quiz: false,
        capital: false
    };

    function formatTime(seconds) {
        const m = Math.floor(seconds / 60);
        const s = seconds % 60;
        const mm = m < 10 ? "0" + m : String(m);
        const ss = s < 10 ? "0" + s : String(s);
        return mm + ":" + ss;
    }

    function updateTimerDisplay() {
        statTimerEl.textContent = formatTime(remainingSeconds);
        statTimerEl.style.color = remainingSeconds <= 10 ? "var(--error)" : "var(--text)";
    }

    function tickTimer() {
        if (gameLocked) return;
        remainingSeconds -= 1;
        if (remainingSeconds <= 0) {
            remainingSeconds = 0;
            updateTimerDisplay();
            handleTimeUp();
            return;
        }
        updateTimerDisplay();
    }

    function startTimer() {
        if (timerId) clearInterval(timerId);
        timerId = setInterval(tickTimer, 1000);
    }

    function handleTimeUp() {
        if (timerId) {
            clearInterval(timerId);
            timerId = null;
        }
        gameLocked = true;

        if (statStatusEl) {
            statStatusEl.textContent = "Ladenschluss!";
            statStatusEl.style.color = "var(--error)";
        }

        doorSignEl.textContent = "ZU SPÄT";
        doorSignEl.classList.remove("door-sign--open");
        doorSignEl.classList.add("door-sign--closed");
        doorEl.classList.remove("door--open");
        doorGlowEl.classList.remove("door-glow--active");

        checkSortBtn.disabled = true;
        checkQuizBtn.disabled = true;
        checkCapitalBtn.disabled = true;
    }

    function updateSolvedStatus() {
        const solvedCount = Object.values(sectionSolved).filter(Boolean).length;
        statSolvedEl.textContent = solvedCount + " / 3";

        if (solvedCount === 3 && !gameLocked && remainingSeconds > 0) {
            openDoor();
        }
    }

    function openDoor() {
        gameLocked = true;
        if (timerId) {
            clearInterval(timerId);
            timerId = null;
        }

        doorEl.classList.add("door--open");
        doorGlowEl.classList.add("door-glow--active");
        doorSignEl.textContent = "OFFEN";
        doorSignEl.classList.remove("door-sign--closed");
        doorSignEl.classList.add("door-sign--open");

        if (statStatusEl) {
            statStatusEl.textContent = "Tür geöffnet!";
            statStatusEl.style.color = "var(--success)";
        }

        checkSortBtn.disabled = true;
        checkQuizBtn.disabled = true;
        checkCapitalBtn.disabled = true;
    }

    // Sortieraufgabe – Drag & Drop
    let draggingCardId = null;

    function createSortCard(cardData) {
        const el = document.createElement("div");
        el.className = "drag-card";
        el.draggable = true;
        el.dataset.cardId = cardData.id;
        el.dataset.correctZone = cardData.correctZone;

        const textSpan = document.createElement("span");
        textSpan.className = "drag-card-text";
        textSpan.textContent = cardData.text;
        el.appendChild(textSpan);

        el.addEventListener("dragstart", (e) => {
            if (gameLocked) {
                e.preventDefault();
                return;
            }
            draggingCardId = cardData.id;
            el.classList.add("dragging");
            e.dataTransfer.effectAllowed = "move";
            e.dataTransfer.setData("text/plain", cardData.id);
        });

        el.addEventListener("dragend", () => {
            draggingCardId = null;
            el.classList.remove("dragging");
        });

        return el;
    }

    function resetSortBoard() {
        sortPoolEl.innerHTML = "";
        sortCardsData.forEach(card => {
            const el = createSortCard(card);
            sortPoolEl.appendChild(el);
        });
        dropzones.forEach(zone => {
            zone.classList.remove("is-over");
            const children = Array.from(zone.children)
                .filter(c => !c.classList.contains("escape-dropzone-label"));
            children.forEach(c => c.remove());
        });
    }

    function handleDragOverZone(e) {
        if (gameLocked) return;
        e.preventDefault();
        e.dataTransfer.dropEffect = "move";
        e.currentTarget.classList.add("is-over");
    }

    function handleDragLeaveZone(e) {
        e.currentTarget.classList.remove("is-over");
    }

    function handleDropZone(e) {
        if (gameLocked) return;
        e.preventDefault();
        const zone = e.currentTarget;
        zone.classList.remove("is-over");

        const cardId = e.dataTransfer.getData("text/plain") || draggingCardId;
        if (!cardId) return;

        const cardEl = document.querySelector(`.drag-card[data-card-id="${cardId}"]`);
        if (!cardEl) return;

        cardEl.classList.remove("correct", "wrong");
        zone.appendChild(cardEl);
    }

    dropzones.forEach(zone => {
        zone.addEventListener("dragover", handleDragOverZone);
        zone.addEventListener("dragleave", handleDragLeaveZone);
        zone.addEventListener("drop", handleDropZone);
    });

    function checkSort() {
        if (gameLocked) return;

        let correct = 0;
        const total = sortCardsData.length;

        document.querySelectorAll(".drag-card").forEach(card => {
            card.classList.remove("correct", "wrong");
        });

        sortCardsData.forEach(cardData => {
            const cardEl = document.querySelector(`.drag-card[data-card-id="${cardData.id}"]`);
            if (!cardEl) return;

            const parentZone = cardEl.closest(".escape-dropzone");
            const zoneName = parentZone ? parentZone.dataset.zone : null;

            if (!zoneName) {
                cardEl.classList.add("wrong");
                return;
            }

            if (zoneName === cardData.correctZone) {
                cardEl.classList.add("correct");
                correct += 1;
            } else {
                cardEl.classList.add("wrong");
            }
        });

        if (correct === total) {
            sectionSolved.sort = true;
            statusSortEl.textContent = "gelöst";
            statusSortEl.className = "section-status section-status--done";
        } else {
            sectionSolved.sort = false;
            statusSortEl.textContent = "noch Fehler";
            statusSortEl.className = "section-status section-status--fail";
        }

        updateSolvedStatus();
    }

    // Quiz
    function checkQuiz() {
        if (gameLocked) return;

        const q1 = document.querySelector('input[name="q1"]:checked');
        const q2 = document.querySelector('input[name="q2"]:checked');

        const quizFeedbackEl = document.getElementById("quiz-feedback");

        if (!q1 || !q2) {
            quizFeedbackEl.textContent = "Bitte jede der beiden Fragen beantworten.";
            sectionSolved.quiz = false;
            statusQuizEl.textContent = "unvollständig";
            statusQuizEl.className = "section-status section-status--fail";
            updateSolvedStatus();
            return;
        }

        const correctQ1 = q1.value === quizSolutions.q1;
        const correctQ2 = q2.value === quizSolutions.q2;

        if (correctQ1 && correctQ2) {
            sectionSolved.quiz = true;
            statusQuizEl.textContent = "gelöst";
            statusQuizEl.className = "section-status section-status--done";
            quizFeedbackEl.textContent = "Beide Antworten sind richtig.";
        } else {
            sectionSolved.quiz = false;
            statusQuizEl.textContent = "noch Fehler";
            statusQuizEl.className = "section-status section-status--fail";
            quizFeedbackEl.textContent = "Mindestens eine Antwort ist falsch.";
        }

        updateSolvedStatus();
    }

    // Mindestkapital
    function checkCapital() {
        if (gameLocked) return;

        let correct = 0;
        const total = Object.keys(capitalSolutions).length;

        capitalSelects.forEach(sel => {
            sel.classList.remove("correct", "wrong");
        });

        capitalSelects.forEach(sel => {
            const form = sel.dataset.form;
            const expected = capitalSolutions[form];
            const chosen = sel.value;

            if (!chosen) {
                sel.classList.add("wrong");
                return;
            }

            if (chosen === expected) {
                sel.classList.add("correct");
                correct += 1;
            } else {
                sel.classList.add("wrong");
            }
        });

        if (correct === total) {
            sectionSolved.capital = true;
            statusCapitalEl.textContent = "gelöst";
            statusCapitalEl.className = "section-status section-status--done";
        } else {
            sectionSolved.capital = false;
            statusCapitalEl.textContent = "noch Fehler";
            statusCapitalEl.className = "section-status section-status--fail";
        }

        updateSolvedStatus();
    }

    // Restart
    function resetGame() {
        if (timerId) clearInterval(timerId);

        remainingSeconds = START_SECONDS;
        updateTimerDisplay();
        gameLocked = false;

        sectionSolved.sort = false;
        sectionSolved.quiz = false;
        sectionSolved.capital = false;

        statusSortEl.textContent = "offen";
        statusSortEl.className = "section-status";
        statusQuizEl.textContent = "offen";
        statusQuizEl.className = "section-status";
        statusCapitalEl.textContent = "offen";
        statusCapitalEl.className = "section-status";

        if (statStatusEl) {
            statStatusEl.textContent = "Laden ist offen";
            statStatusEl.style.color = "var(--text)";
        }

        statSolvedEl.textContent = "0 / 3";

        doorEl.classList.remove("door--open");
        doorGlowEl.classList.remove("door-glow--active");
        doorSignEl.textContent = "GESCHLOSSEN";
        doorSignEl.classList.add("door-sign--closed");
        doorSignEl.classList.remove("door-sign--open");

        sortPoolEl.innerHTML = "";
        resetSortBoard();

        document.querySelectorAll('input[name="q1"]').forEach(i => i.checked = false);
        document.querySelectorAll('input[name="q2"]').forEach(i => i.checked = false);
        document.getElementById("quiz-feedback").textContent = "Wähle je Frage eine Antwort.";

        capitalSelects.forEach(sel => {
            sel.value = "";
            sel.classList.remove("correct", "wrong");
        });

        checkSortBtn.disabled = false;
        checkQuizBtn.disabled = false;
        checkCapitalBtn.disabled = false;

        startTimer();
    }

    checkSortBtn.addEventListener("click", checkSort);
    checkQuizBtn.addEventListener("click", checkQuiz);
    checkCapitalBtn.addEventListener("click", checkCapital);
    restartBtn.addEventListener("click", resetGame);

    // JSON laden und Daten einspielen
    async function loadConfig() {
        const res = await fetch(CONFIG_URL);
        const config = await res.json();

        const sortSection = config.sections.find(s => s.type === "sort");
        const quizSection = config.sections.find(s => s.type === "quiz");
        const capitalSection = config.sections.find(s => s.type === "capital");

        if (sortSection && Array.isArray(sortSection.sortCards)) {
            sortCardsData = sortSection.sortCards;
        }

        if (quizSection && Array.isArray(quizSection.questions)) {
            quizSolutions = {};
            quizSection.questions.forEach(q => {
                quizSolutions[q.id] = q.correct;

                const qRoot = document.querySelector(`.quiz-question[data-quiz-id="${q.id}"]`);
                if (!qRoot) return;

                const textEl = qRoot.querySelector(".quiz-text");
                if (textEl) textEl.textContent = q.text;

                const listEl = qRoot.querySelector(".quiz-options");
                if (listEl && Array.isArray(q.options)) {
                    listEl.innerHTML = "";
                    q.options.forEach(o => {
                        const li = document.createElement("li");
                        li.innerHTML = `<label><input type="radio" name="${q.id}" value="${o.value}"> ${o.text}</label>`;
                        listEl.appendChild(li);
                    });
                }
            });
        }

        if (capitalSection && Array.isArray(capitalSection.rows)) {
            capitalSolutions = {};
            capitalSection.rows.forEach(row => {
                // wir nutzen das Label als Schlüssel, also muss data-form im HTML gleich sein
                capitalSolutions[row.label] = row.correct;

                const sel = document.querySelector(`select[data-form="${row.label}"]`);
                if (sel && Array.isArray(row.options)) {
                    sel.innerHTML = "";
                    row.options.forEach(o => {
                        const opt = document.createElement("option");
                        opt.value = o.value;
                        opt.textContent = o.text;
                        sel.appendChild(opt);
                    });
                }
            });
        }

        resetSortBoard();
        resetGame();
    }

    loadConfig().catch(err => {
        console.error("Fehler beim Laden der JSON:", err);
        // Fallback: Spiel trotzdem initialisieren
        resetGame();
    });
</script>
</body>

</html>

<!-- what_and_why.html -->
<!DOCTYPE html>
<html lang="de">

<head>
<meta charset="UTF-8">
<title>What &amp; Why â€“ Template</title>
<link rel="stylesheet" href="styles.css">
</head>

<body>
<div class="page" style="display:block;">
<main class="panel">
<header class="header">
<div class="title-block">
<h1>What &amp; Why</h1>
<p>Schritt 1: eine Antwort (What) wÃ¤hlen Â· Schritt 2: passende BegrÃ¼ndungen (Why) markieren.</p>
</div>
<div class="stats">
<div class="stat-chip stat-chip--round">
<span>Fall</span>
<span id="round-label">1 / 1</span>
</div>
<div class="stat-chip">
<span>What-Punkte</span>
<span id="score-form">0</span>
</div>
<div class="stat-chip">
<span>Why-Punkte</span>
<span id="score-reason">0</span>
</div>
<div class="stat-chip stat-chip--success">
<span>Gesamt</span>
<span id="score-total">0</span>
</div>
</div>
</header>

<div class="toolbar">
<div class="pill">
<strong>How to:</strong> Erst ein What wÃ¤hlen (Toggle-Frage). Danach erscheinen passende Why-Statements als Checkbox-Quiz.
</div>
<button class="btn-secondary btn" id="restart-btn" type="button">
<span>â†»</span> Reset
</button>
</div>

<section class="case-card">
<div class="case-label">Fallbeschreibung</div>
<div class="case-body" id="case-text"></div>
<div class="case-tags" id="case-tags"></div>
</section>

<section class="options-group" id="what-group">
<h3 class="section-title">1 Â· What auswÃ¤hlen (Einfachauswahl)</h3>
<ul class="option-list" id="form-options"></ul>
</section>

<section class="options-group" id="why-group">
<h3 class="section-title">2 Â· Why-BegrÃ¼ndungen (Mehrfachauswahl)</h3>
<ul class="option-list" id="reason-options"></ul>
</section>

<div style="display:flex;justify-content:space-between;align-items:center;gap:8px;margin-top:8px;">
<div class="feedback" id="feedback-box">
WÃ¤hle zuerst ein What. Danach erscheinen passende Why-Optionen.
</div>
<button class="btn" id="check-btn" type="button">
<span>âœ”</span> Antwort prÃ¼fen
</button>
</div>
</main>

<aside class="panel" style="display:none;">
<div class="info-section" id="info-section"></div>
<div class="summary-box" id="summary-box"></div>
</aside>
</div>

<script>
let cases = [];
let order = [];
let currentIndex = 0;
let scoreWhat = 0;
let scoreWhy = 0;
let evaluated = false;
let selectedWhatId = null;

const roundLabelEl = document.getElementById("round-label");
const scoreFormEl = document.getElementById("score-form");
const scoreReasonEl = document.getElementById("score-reason");
const scoreTotalEl = document.getElementById("score-total");

const caseTextEl = document.getElementById("case-text");
const caseTagsEl = document.getElementById("case-tags");
const formOptionsEl = document.getElementById("form-options");
const reasonOptionsEl = document.getElementById("reason-options");
const feedbackBoxEl = document.getElementById("feedback-box");
const infoSectionEl = document.getElementById("info-section");
const summaryBoxEl = document.getElementById("summary-box");
const whyGroupEl = document.getElementById("why-group");

const checkBtn = document.getElementById("check-btn");
const restartBtn = document.getElementById("restart-btn");

function shuffleArray(arr) {
const a = arr.slice();
for (let i = a.length - 1; i > 0; i--) {
const j = Math.floor(Math.random() * (i + 1));
[a[i], a[j]] = [a[j], a[i]];
}
return a;
}

function initOrder() {
order = shuffleArray(cases.map((c, idx) => idx));
}

function getCurrentCase() {
return cases[order[currentIndex]];
}

function renderCase() {
const c = getCurrentCase();
if (!c) {
feedbackBoxEl.className = "feedback error";
feedbackBoxEl.textContent = "Keine Falldaten gefunden.";
checkBtn.disabled = true;
restartBtn.disabled = true;
return;
}

selectedWhatId = null;
evaluated = false;

roundLabelEl.textContent = `${currentIndex + 1} / ${cases.length}`;
caseTextEl.textContent = c.profile;
caseTagsEl.innerHTML = "";
c.tags.forEach(tag => {
const span = document.createElement("span");
span.className = "case-tag";
span.textContent = tag;
caseTagsEl.appendChild(span);
});

// What-Optionen
formOptionsEl.innerHTML = "";
c.options.forEach(option => {
const li = document.createElement("li");
li.className = "option";
const id = `what-${c.id}-${option.id}`;
li.innerHTML = `
<label class="option-label" for="${id}">
<input type="radio" name="what" id="${id}" value="${option.id}">
<div class="option-text">
${option.label}
<div class="option-badge">What</div>
</div>
</label>
`;
formOptionsEl.appendChild(li);
});

// Listener fÃ¼r What-Toggle
formOptionsEl
.querySelectorAll('input[name="what"]')
.forEach(input => input.addEventListener("change", onWhatChanged));

// Why-Bereich zurÃ¼cksetzen/verstecken
whyGroupEl.style.display = "none";
reasonOptionsEl.innerHTML = "";

feedbackBoxEl.className = "feedback";
feedbackBoxEl.innerHTML = "WÃ¤hle zuerst eine Antwort oben (What). Danach erscheinen passende Why-Statements.";
infoSectionEl.innerHTML = "";
checkBtn.disabled = false;
checkBtn.innerHTML = '<span>âœ”</span> Antwort prÃ¼fen';
}

function onWhatChanged(event) {
const c = getCurrentCase();
selectedWhatId = event.target.value;
const option = c.options.find(o => o.id === selectedWhatId);
if (!option) return;

// Why-Checkboxen passend zum gewÃ¤hlten What aufbauen
reasonOptionsEl.innerHTML = "";
option.whys.forEach(why => {
const li = document.createElement("li");
li.className = "option";
const id = `why-${c.id}-${selectedWhatId}-${why.id}`;
li.innerHTML = `
<label class="option-label" for="${id}">
<input type="checkbox" id="${id}" value="${why.id}">
<div class="option-text">
${why.text}
<div class="option-badge">Why</div>
</div>
</label>
`;
reasonOptionsEl.appendChild(li);
});

reasonOptionsEl
.querySelectorAll('input[type="checkbox"]')
.forEach(cb => cb.disabled = false);

whyGroupEl.style.display = "";
feedbackBoxEl.className = "feedback";
feedbackBoxEl.innerHTML = "Jetzt passende Why-BegrÃ¼ndungen markieren und auf <strong>Antwort prÃ¼fen</strong> klicken.";
}

function getSelectedReasons() {
const checked = Array.from(reasonOptionsEl.querySelectorAll('input[type="checkbox"]:checked'));
return checked.map(cb => cb.value);
}

function evaluate() {
if (evaluated) return;

const c = getCurrentCase();
if (!c) return;

if (!selectedWhatId) {
feedbackBoxEl.className = "feedback error";
feedbackBoxEl.textContent = "Bitte zuerst ein What auswÃ¤hlen.";
return;
}

const option = c.options.find(o => o.id === selectedWhatId);
if (!option) return;

const selectedReasons = getSelectedReasons();

// Eingaben sperren
formOptionsEl.querySelectorAll("input").forEach(i => i.disabled = true);
reasonOptionsEl.querySelectorAll("input").forEach(i => i.disabled = true);

let whatPoints = 0;
let whyPoints = 0;

// What-Bewertung
const formLabels = formOptionsEl.querySelectorAll(".option-label");
formLabels.forEach(lbl => {
const input = lbl.querySelector("input");
const optId = input.value;
const opt = c.options.find(o => o.id === optId);

if (opt && opt.isCorrect) {
lbl.classList.add("correct");
}
if (input.checked && (!opt || !opt.isCorrect)) {
lbl.classList.add("wrong");
}
lbl.classList.add("disabled");
});

if (option.isCorrect) {
whatPoints = 1;
scoreWhat += 1;
}

// Why-Bewertung relativ zum gewÃ¤hlten What
const correctWhyIds = option.whys.filter(w => w.correct).map(w => w.id);
const selectedSet = new Set(selectedReasons);
const correctSet = new Set(correctWhyIds);

const allMatch =
correctSet.size === selectedSet.size &&
[...correctSet].every(id => selectedSet.has(id));

const reasonLabels = reasonOptionsEl.querySelectorAll(".option-label");
reasonLabels.forEach(lbl => {
const input = lbl.querySelector("input");
const id = input.value;
const isCorrect = correctSet.has(id);

if (isCorrect) {
lbl.classList.add("correct");
}
if (input.checked && !isCorrect) {
lbl.classList.add("wrong");
}
lbl.classList.add("disabled");
});

if (allMatch && correctWhyIds.length > 0) {
whyPoints = 1;
scoreWhy += 1;
}

const gained = whatPoints + whyPoints;
scoreFormEl.textContent = scoreWhat;
scoreReasonEl.textContent = scoreWhy;
scoreTotalEl.textContent = scoreWhat + scoreWhy;

if (gained === 2) {
feedbackBoxEl.className = "feedback success";
feedbackBoxEl.innerHTML = `Top: Deine Wahl (What) und die Why-BegrÃ¼ndungen passen perfekt. (+2 Punkte)`;
} else if (whatPoints === 1 && whyPoints === 0) {
feedbackBoxEl.className = "feedback";
feedbackBoxEl.innerHTML = `Das What passt (+1 Punkt), bei den Why-Statements ist noch Luft nach oben.`;
} else if (whatPoints === 0 && whyPoints === 1) {
feedbackBoxEl.className = "feedback";
feedbackBoxEl.innerHTML = `Deine Why-Argumentation ist stimmig (+1 Punkt), aber das What war nicht optimal gewÃ¤hlt.`;
} else {
feedbackBoxEl.className = "feedback error";
feedbackBoxEl.innerHTML = `What und Why Ã¼berzeugen noch nicht â€“ schau dir den LÃ¶sungshinweis an. (0 Punkte)`;
}

if (c.solution) {
infoSectionEl.innerHTML = `<strong>LÃ¶sungshinweis:</strong> ${c.solution}`;
}

evaluated = true;
checkBtn.innerHTML =
currentIndex < cases.length - 1
? '<span>âž¡</span> NÃ¤chster Fall'
: '<span>ðŸ“Š</span> Auswertung';
}

function showFinalSummary() {
const maxWhat = cases.length;
const maxWhy = cases.length;
const total = scoreWhat + scoreWhy;
const maxTotal = maxWhat + maxWhy;

summaryBoxEl.innerHTML = `
<strong>Auswertung:</strong><br>
What-Punkte: ${scoreWhat} / ${maxWhat}<br>
Why-Punkte: ${scoreWhy} / ${maxWhy}<br>
Gesamt: ${total} / ${maxTotal}<br><br>
`;
feedbackBoxEl.className = "feedback";
feedbackBoxEl.textContent = "Spiel beendet.";
checkBtn.disabled = true;
}

function nextStep() {
if (!evaluated) {
evaluate();
} else {
if (currentIndex < cases.length - 1) {
currentIndex += 1;
renderCase();
} else {
showFinalSummary();
}
}
}

function restart() {
scoreWhat = 0;
scoreWhy = 0;
currentIndex = 0;
scoreFormEl.textContent = "0";
scoreReasonEl.textContent = "0";
scoreTotalEl.textContent = "0";
summaryBoxEl.innerHTML = "";
initOrder();
renderCase();
}

async function loadCases() {
try {
const res = await fetch("cases.json");
const data = await res.json();
cases = data.cases || [];

if (!cases.length) {
throw new Error("Leere cases.json");
}

initOrder();
renderCase();
} catch (err) {
console.error(err);
feedbackBoxEl.className = "feedback error";
feedbackBoxEl.textContent = "Fehler beim Laden der Falldaten (cases.json).";
checkBtn.disabled = true;
restartBtn.disabled = true;
}
}

checkBtn.addEventListener("click", nextStep);
restartBtn.addEventListener("click", restart);

loadCases();
</script>
</body>

</html>
